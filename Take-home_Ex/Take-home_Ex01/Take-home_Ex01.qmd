---
title: "Creating Data Visualisation Beyond Default"
title-block-banner: "#F0FFFF"
author: "Wang Yaling"
date: "Jan 14, 2024"
date-modified: last-modified
date-format: medium
excute:
  eval: true
  echo: true
  warning: false
editor: visual
abstract: 
    This document explores the 2022 Programme for International Student Assessment (PISA) data using appropriate Exploratory Data Analysis (EDA) methods and ggplot2 functions. The primary goal is to practice creating data visualizations beyond default parameters.
---

# 1. Loading packages and reading data

The data set under analysis is derived from [PISA](https://www.oecd.org/pisa/data/2022database/) data ([Student questionnaire data file](https://webfs.oecd.org/pisa2022/STU_QQQ_SAS.zip)). The original data set is a SAS data set, and it needs to be read using `read.sas()`.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
pacman::p_load(ggrepel, patchwork, ggthemes, hrbrthemes, tidyverse, haven, viridis) 
```

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
stu_qqq <- read_sas("data/cy08msp_stu_qqq.sas7bdat")
dimensions <- dim(stu_qqq)
cat("Rows:", dimensions[1], " Columns:", dimensions[2])
```

The original data set has a total of 613,744 rows and 1,279 columns.

# 2. Filter SG student records

In this practice, only Singapore students will be visually analysed. Therefore, the first step is to filter SG student records.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
stu_qqq_SG <- stu_qqq %>% 
  filter(CNT == "SGP")
write_rds(stu_qqq_SG, "data/stu_qqq_SG.rds")
stu_qqq_SG <- read_rds("data/stu_qqq_SG.rds")
dimensions_SG <- dim(stu_qqq_SG)
cat("Rows:", dimensions_SG[1], " Columns:", dimensions_SG[2])
```

The filtered records has 6,606 rows and 1,279 columns, which means there is a number of 6,606 SG students involved in this questionnaire, and each of them has 1,279 data related. The filtered data set was saved as **stu_qqq_SG.rds**.

# 3. Student Performance

## 3.1 Mean of Plausible Values

The **stu_qqq_SG.rds**. includes 10 **Plausible Values** (PV) for **Math**, **Reading**, and **Science** each. To assess the performance of SG students in each subject, the average PV for each subject will be calculated as follows:

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
Avg_PVMath <- rowMeans(stu_qqq_SG[, c("PV1MATH", "PV2MATH", "PV3MATH", "PV4MATH", "PV5MATH", "PV6MATH", "PV7MATH", "PV8MATH", "PV9MATH", "PV10MATH")])
Avg_PVRead <- rowMeans(stu_qqq_SG[, c("PV1READ", "PV2READ", "PV3READ", "PV4READ", "PV5READ", "PV6READ", "PV7READ", "PV8READ", "PV9READ", "PV10READ")])
Avg_PVScience <- rowMeans(stu_qqq_SG[, c("PV1SCIE", "PV2SCIE", "PV3SCIE", "PV4SCIE", "PV5SCIE", "PV6SCIE", "PV7SCIE", "PV8SCIE", "PV9SCIE", "PV10SCIE")])

PV_Avg <- cbind(stu_qqq_SG["CNTSTUID"], Avg_PVMath, Avg_PVRead, Avg_PVScience)
write_rds(PV_Avg, "data/stu_qqq_SG_PV_Avg.rds")

head(PV_Avg)
```

Each SG student's **Avg_PVMath**, **Avg_PVRead**, and **Avg_PVScience** values reflect their proficiency in Math, Reading, and Science, respectively. In the table above, the first row shows the performance scores of Math, Reading and Science for student "70200001" is 605.2533, 667.4296, 639.7873, respectively.

Refer to the [instruction](https://www.oecd.org/pisa/data/httpoecdorgpisadatabase-instructions.htm) and the [PISA Data Analysis Manual](https://read.oecd-ilibrary.org/education/pisa-data-analysis-manual-spss-second-edition_9789264056275-en#page1) to learn more about Plausible Value.

## 3.2 Distribution of Performance

### 3.2.1 Analyse

#### 3.2.1.1 One Subject

First, let's see the frequency of each subject's performance scores by histogram.

**Histogram**

::: panel-tabset
## Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
#| warning: false
ggplot(data = PV_Avg, aes(x=Avg_PVMath)) +
  geom_histogram(bins=20, boundary = 100, color="grey25", fill="grey90") +
  geom_vline(aes(xintercept = mean(PV_Avg$Avg_PVMath), linetype="Mean", color="Mean"), size=1) +
  geom_vline(aes(xintercept = median(PV_Avg$Avg_PVMath), linetype="Median", color="Median"), size=1) +
  scale_linetype_manual(name = "Statistic", values = c(Mean = "dashed", Median = "dashed")) +
  scale_color_manual(name = "Statistic", values = c(Mean = "blue", Median = "red")) +
  ggtitle("Distribution of SG Students' Math Scores") +
  labs(color = "Statistic", x="Math Score") + 
  theme_clean() +
  theme(
    legend.position = c(0.9, 0.7),
    legend.text = element_text(size = 10),
    legend.key.size = unit(5, "mm")
  )
```

## Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
#| warning: false
ggplot(data = PV_Avg, aes(x=Avg_PVRead)) +
  geom_histogram(bins=20, boundary = 100, color="grey25", fill="grey90") +
  geom_vline(aes(xintercept = mean(PV_Avg$Avg_PVRead), linetype="Mean", color="Mean"), size=1) +
  geom_vline(aes(xintercept = median(PV_Avg$Avg_PVRead), linetype="Median", color="Median"), size=1) +
  scale_linetype_manual(name = "Statistic", values = c(Mean = "dashed", Median = "dashed")) +
  scale_color_manual(name = "Statistic", values = c(Mean = "blue", Median = "red")) +
  ggtitle("Distribution of SG Students' Reading Scores") +
  labs(color = "Statistic", x = "Reading Score") + 
  theme_clean() +
  theme(
    legend.position = c(0.9, 0.7),
    legend.text = element_text(size = 10),
    legend.key.size = unit(5, "mm")
  )
```

## Science

```{r}
#| warning: false
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg, aes(x=Avg_PVScience)) +
  geom_histogram(bins=20, boundary = 100, color="grey25", fill="grey90") +
  geom_vline(aes(xintercept = mean(PV_Avg$Avg_PVScience), linetype="Mean", color="Mean"), size=1) +
  geom_vline(aes(xintercept = median(PV_Avg$Avg_PVScience), linetype="Median", color="Median"), size=1) +
  scale_linetype_manual(name = "Statistic", values = c(Mean = "dashed", Median = "dashed")) +
  scale_color_manual(name = "Statistic", values = c(Mean = "blue", Median = "red")) +
  ggtitle("Distribution of SG Students' Science Scores") +
  labs(color = "Statistic", x="Science Scores") + 
  theme_clean() +
  theme(
    legend.position = c(0.9, 0.7),
    legend.text = element_text(size = 10),
    legend.key.size = unit(5, "mm")
  )
```
:::

The three histograms depicted above show a **left-skewed** distribution, indicating that many values are concentrated near the lower end of the range, with infrequent higher values. This is reflected in a mean score lower than the median. This may be due to some students with extremely low scores pulling down the mean, which we can see in the following box plot.

Next, let's use box plot to explore more.

**Boxplot**

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
PV_Avg_tidy <- PV_Avg %>%
  pivot_longer(cols = c(Avg_PVMath, Avg_PVRead, Avg_PVScience), names_to = "Subject", values_to = "Score")

max_values <- PV_Avg_tidy %>% group_by(Subject) %>% summarise(max_value = max(Score))

ggplot(PV_Avg_tidy, aes(x = Subject, y = Score)) +
  geom_boxplot() +
  facet_grid(. ~ Subject, scales = "free_x") +
  geom_hline(data = max_values, aes(yintercept = max_value, linetype = "Max"), color = "blue", show.legend = FALSE, linewidth = 1) +
  geom_text(data = max_values, aes(x = Subject, y = max_value, label = sprintf("Max: %.2f", max_value)), size = 3, vjust = -0.5, hjust = 0.5, color = "blue") +
  geom_hline(aes(yintercept = median(Score), linetype = "Median"), color = "tomato",show.legend = FALSE, linewidth = 1) +
  coord_cartesian(ylim = range(PV_Avg_tidy$Score)) +
  ggtitle("Box Plot Comparison of Subject Scores")


```

The three box plots reveal:

1.  Some students scored extremely low, especially in Reading, followed by Science and Math.

2.  Median scores follow the order: Math \> Science \> Reading.

3.  Maximum scores follow the order: Math \> Science \> Reading.

4.  Over 75% of students scored above 500 in Math and 75% of students scored above 500 in Science, while less than 75% scored above 500 in Reading.

Next, by using density curve, we can see more of the distribution and central tendency of the performance scores.

**Density curve**

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
  peak_math <- density(PV_Avg$Avg_PVMath)$x[which.max(density(PV_Avg$Avg_PVMath)$y)]
  peak_read <- density(PV_Avg$Avg_PVRead)$x[which.max(density(PV_Avg$Avg_PVRead)$y)]
  peak_science <- density(PV_Avg$Avg_PVScience)$x[which.max(density(PV_Avg$Avg_PVScience)$y)]
  
ggplot(data = PV_Avg) +
  geom_density(aes(x = Avg_PVMath, color = "Math"), fill = "blue", alpha = 0.2) +
  geom_density(aes(x = Avg_PVRead, color = "Reading"), fill = "green", alpha = 0.2) +
  geom_density(aes(x = Avg_PVScience, color = "Science"), fill = "red", alpha = 0.2) +
  ggtitle("Density of SG Students' Performance") +
  labs(x = "Average of Plausible Value") +
  geom_vline(aes(xintercept = peak_math, color = "Math"), linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = peak_read, color = "Reading"), linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = peak_science, color = "Science"), linetype = "dashed", size = 1) +
  geom_text(aes(x = peak_math, y = 0, label = sprintf("Math: %.2f", peak_math)), 
            vjust = - 0.5, hjust = 0.2, color = "blue", size = 3.5) +
  geom_text(aes(x = peak_read, y = 0, label = sprintf("Reading: %.2f", peak_read)), 
            vjust = - 3.5, hjust = 0.2, color = "green", size = 3.5) +
  geom_text(aes(x = peak_science, y = 0, label = sprintf("Science: %.2f", peak_science)),
            vjust = - 8, hjust = 0.2, color = "red", size = 3.5) +
  scale_color_manual(values = c("Math" = "blue", "Reading" = "green", "Science" = "red"), name = "Subject") +
  theme_clean() +
  theme(
    legend.position = c(0.9, 0.8),
    legend.text = element_text(size = 9),
    legend.key.size = unit(5, "mm")
  )
```

The three density curves above reveal:

1.  The performance for all three subjects show a tendency towards a leftward skew in their distributions.

2.  Math scores are centered around 600, Science scores around 580, and Reading scores around 560.

Last, let's present the distribution by violin plots.

**Violin plot**

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg) +
  geom_violin(aes(x = "Math", y = Avg_PVMath, fill = "Math"), position = "dodge", alpha = 0.5) +
  geom_violin(aes(x = "Reading", y = Avg_PVRead, fill = "Reading"), position = "dodge", alpha = 0.5) +
  geom_violin(aes(x = "Science", y = Avg_PVScience, fill = "Science"), position = "dodge", alpha = 0.5) +
  ggtitle("Violin Plot of SG Students' Performance") +
  labs(fill = "Subject", x = "Subject", y = "Plausible Value") +
  theme_clean() +
  theme(
    legend.position = c(0.9, 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(4, "mm")
  )

```

The three violin plots reveal:

1.  Scores for all three subjects are mainly concentrated between 500-700.

2.  Math scores are centered above 600, while Reading and Science scores are primarily distributed in the 500-600 range. Moreover, the peak value for Science scores is higher than the peak value for Reading scores.

3.  The performance distribution for all three subjects is left-skewed, with the lower half of the violin plots being longer.

#### 3.2.1.2 Two Subjects

::: panel-tabset
## Math vs Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg, 
       aes(x = Avg_PVMath, 
           y = Avg_PVRead)) +
  geom_point(color = "dodgerblue") +
  geom_smooth(formula = y ~ x, method = lm, color = "black") +
  geom_text(aes(x = max(Avg_PVMath), y = max(Avg_PVRead),
                label = paste("y = ", round(coef(lm(Avg_PVRead ~ Avg_PVMath))[2], 2), "x + ", round(coef(lm(Avg_PVRead ~ Avg_PVMath))[1], 2))),
            hjust = 1.5, vjust = 1, color = "black", size = 4) +
  ggtitle("Math vs Reading") +
  labs(x = "Math Score", y = "Reading Score", color = "Math Score") +
  theme_clean()
```

## Math vs Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg, 
       aes(x = Avg_PVMath, 
           y = Avg_PVScience)) +
  geom_point(color = "forestgreen") +
  geom_smooth(formula = y ~ x, method = lm, color = "black") +
  geom_text(aes(x = max(Avg_PVMath), y = max(Avg_PVScience),
                label = paste("y = ", round(coef(lm(Avg_PVScience ~ Avg_PVMath))[2], 2), "x + ", round(coef(lm(Avg_PVScience ~ Avg_PVMath))[1], 2))),
            hjust = 1.5, vjust = 1, color = "black", size = 4) +
  ggtitle("Math vs Science") +
  labs(x = "Math Score", y = "Science Score", color = "Math Score") +
  theme_clean()
```

## Science vs Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg, 
       aes(x = Avg_PVRead, 
           y = Avg_PVScience)) +
  geom_point(color = "tomato") +
  geom_smooth(formula = y ~ x, method = lm, color = "black") +
  geom_text(aes(x = max(Avg_PVRead), y = max(Avg_PVScience),
                label = paste("y = ", round(coef(lm(Avg_PVScience ~ Avg_PVRead))[2], 2), "x + ", round(coef(lm(Avg_PVScience ~ Avg_PVRead))[1], 2))),
            hjust = 1.5, vjust = 1, color = "black", size = 4) +
  ggtitle("Reading vs Science") +
  labs(x = "Reading Score", y = "Science Score", color = "Reading Score") +
  theme_clean()
```
:::

From the three scatter plots above and their respective fit curves, it can be observed that the scores of the three subjects are positively correlated in pairs. As the scores in Math increase, the corresponding scores in Reading and Science also increase, with Science scores being higher. Similarly, when Reading scores are higher, Science scores also tend to be higher.

#### 3.2.1.3 Three Subjects

From the three colored scatter plots below, we can observe a positive trend: as the scores of any two subjects increase, the score of the third subject also tends to rise. This is visually represented by lighter colors and higher values towards the upper right corner, indicating superior performance. Conversely, when the scores of any two subjects decrease, the score of the third subject tends to decrease as well, reflected in darker colors and lower values towards the lower left corner. This pattern suggests a positive correlation among the performance scores of the three subjects, highlighting that higher scores in one subject are associated with higher scores in the others.

::: panel-tabset
## Math vs Reading with Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg, 
       aes(x = Avg_PVMath, 
           y = Avg_PVRead, 
           color = Avg_PVScience)) +
  geom_point() +
  ggtitle("Math vs Reading with Science") +
  labs(x = "Math Score", y = "Reading Score", color = "Science Score") +
  theme_clean()

```

## Math vs Science with Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg, 
       aes(x = Avg_PVMath, 
           y = Avg_PVScience, 
           color = Avg_PVRead)) +
  geom_point() +
  ggtitle("Math vs Science with Reading") +
  labs(x = "Math Score", y = "Science Score", color = "Reading Score") +
  scale_color_continuous("Reading Score", breaks = seq(200, 800, by = 100), 
                          low = "darkgreen", high = "lightgreen") +
  theme_clean()
```

## Reading vs Science with Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg, 
       aes(x = Avg_PVRead, 
           y = Avg_PVScience, 
           color = Avg_PVMath)) +
  geom_point() +
  ggtitle("Reading vs Science with Math") +
  labs(x = "Reading Score", y = "Science Score", color = "Math Score") +
  scale_color_continuous("Math Score", breaks = seq(200, 800, by = 100), 
                          low = "red", high = "pink") +
  theme_clean()
```
:::

## 3.3 Summary

# 4. Performance Influencers

## 4.1 Gender

The code chunk below is for creating another data set which includes SG students' **gender** and performance scores in **Math**, **Read** and **Science**. The new data set was saved as **stu_qqq_SG_PV_Avg_gender.rds**.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
PV_Avg_gender <- cbind(PV_Avg, gender = stu_qqq_SG$ST004D01T)
write_rds(PV_Avg_gender, "data/stu_qqq_SG_PV_Avg_gender.rds")
head(PV_Avg_gender)
```

::: callout-tip
In the original data set, the column "ST004D01T" records student's gender, "1" represent female, "2" represent male. ([Computer-Based Student Questionnaire for Pisa 2022 - Main Survey Version](https://www.oecd.org/pisa/data/2022database/CY8_202111_QST_MS_STQ_CBA_NoNotes.pdf))
:::

### 4.1.1 Analyse

let's see how gender influence student's performance on the three subjects by histogram.

**Histogram**

::: panel-tabset
## Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
#| warning: false
ggplot(data = PV_Avg_gender, 
       aes(x = Avg_PVMath, 
           fill = as.factor(gender))) +
  geom_histogram(bins = 20, 
                 color = "black") +
  scale_fill_manual(values = c("1" = "tomato", "2" = "dodgerblue"), 
                    breaks = c("1", "2"), 
                    labels = c("Female", "Male")) +
  labs(fill = "Gender", x = "Math Score") +
  ggtitle("Performance of Math by Gender") +
  theme_clean()
```

## Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
#| warning: false
ggplot(data = PV_Avg_gender, 
       aes(x = Avg_PVRead, 
           fill = as.factor(gender))) +
  geom_histogram(bins = 20, 
                 color = "black") +
  scale_fill_manual(values = c("1" = "tomato", "2" = "dodgerblue"), 
                    breaks = c("1", "2"), 
                    labels = c("Female", "Male")) +
  labs(fill = "Gender", x = "Reading Score") +
  ggtitle("Performance of Reading by Gender") +
  theme_clean()
```

## Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
#| warning: false
ggplot(data = PV_Avg_gender, 
       aes(x = Avg_PVScience, 
           fill = as.factor(gender))) +
  geom_histogram(bins = 20, 
                 color = "black") +
  scale_fill_manual(values = c("1" = "tomato", "2" = "dodgerblue"), 
                    breaks = c("1", "2"), 
                    labels = c("Female", "Male")) +
  labs(fill = "Gender", x = "Science Score") +
  ggtitle("Performance of Science by Gender") +
  theme_clean()
```
:::

From the three histograms above:

1.  Overall, male and female performances are fairly balanced in all three subjects, with similar proportions across most score ranges, except for scores above 700.

2.  In the high-score range (above 700), particularly near 800, by looking at the proportion, there are more males excelling in Math and Science, while females excel in Reading.

Next, let's explore more by density curve.

**Density curve**

::: panel-tabset
## Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
#| warning: false
ggplot(data = PV_Avg_gender, 
       aes(x = Avg_PVMath, 
           color = as.factor(gender))) +
  geom_density(alpha = 0, size = 1) +
  scale_color_manual(values = c("1" = "tomato", "2" = "dodgerblue"), 
                     breaks = c("1", "2"), 
                     labels = c("Female", "Male")) +
  labs(color = "Gender", x = "Math Score") +
  ggtitle("Density Plot of Math Performance by Gender") +
  theme_clean()
```

## Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
#| warning: false
ggplot(data = PV_Avg_gender, 
       aes(x = Avg_PVRead, 
           color = as.factor(gender))) +
  geom_density(alpha = 0, size = 1) +
  scale_color_manual(values = c("1" = "tomato", "2" = "dodgerblue"), 
                     breaks = c("1", "2"), 
                     labels = c("Female", "Male")) +
  labs(color = "Gender", x = "Reading Score") +
  ggtitle("Density Plot of Reading Performance by Gender") +
  theme_clean()
```

## Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_gender, 
       aes(x = Avg_PVScience, 
           color = as.factor(gender))) +
  geom_density(alpha = 0, size = 1) +
  scale_color_manual(values = c("1" = "tomato", "2" = "dodgerblue"), 
                     breaks = c("1", "2"), 
                     labels = c("Female", "Male")) +
  labs(color = "Gender", x = "Science Score") +
  ggtitle("Density Plot of Science Performance by Gender") +
  theme_clean()
```
:::

From the above three density curves, we can observe the following:

1.  Both male and female students exhibit a left-skewed trend in their performance scores across the three subjects.

2.  In terms of Math performance, female scores are concentrated around 600, while male scores are concentrated around 650, indicating that the majority of male students perform better in mathematics than the majority of female students.

3.  Regarding Reading performance, both male and female scores are concentrated around 550-600, approximately at 580. In the lower score range (\<500), there are more male students, represented by the area under the curve below 500 being larger for males than females. Similarly, in the higher score range (\>600), there are more female students, represented by the area under the curve above 600 being larger for females than males. This suggests that the majority of female students outperform male students in reading.

4.  In Science performance, female scores are concentrated below 600 (around 580), while male scores are concentrated above 600 (around 610). This indicates that the majority of male students perform better in science than the majority of female students. In the higher score range (\>600), there are more male students, represented by the area under the curve above 600 being larger for males than females.

### 4.1.2 Summary

## 4.2 School

The code chunk below is for creating another data set which includes SG **schools** and performance scores in **Math**, **Read** and **Science**. The new data set was saved as **stu_qqq_SG_PV_Avg_school.rds**.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
PV_Avg_school <- cbind(PV_Avg, school = stu_qqq_SG$CNTSCHID)
write_rds(PV_Avg_school, "data/stu_qqq_SG_PV_Avg_school.rds")
head(PV_Avg_school)
```

The code chunk below is for the calculation of the total number of schools surveyed in the questionnaire, as well as the number of respondents for each school.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
school_counts <- PV_Avg_school %>%
  group_by(school) %>%
  summarise(STUCount = n_distinct(CNTSTUID))

school_counts
```

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
total_schools <- n_distinct(school_counts$school)
cat("There are", total_schools, "SG schools in this data set.")
```

The code chunk below calculates the mean scores for Math, Reading and Science for all surveyed students in each school. This process provides representative scores for three subjects for each school.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
PV_Avg_school_group <- PV_Avg_school %>%
  group_by(school) %>%
  summarise(
    School_Avg_PVMath = mean(Avg_PVMath),
    School_Avg_PVRead = mean(Avg_PVRead),
    School_Avg_PVScience = mean(Avg_PVScience)
  )

# Print the first few rows of the new data set
write_rds(PV_Avg_school_group, "data/stu_qqq_SG_PV_Avg_school_group.rds")
head(PV_Avg_school_group)

```

### 4.2.1 Analyse

Let's see the schools performance by dot plot.

**Dot plot**

::: panel-tabset
## School vs Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_school_group, aes(x = school, y = School_Avg_PVMath)) +
  geom_point(color = "dodgerblue") +
  geom_smooth(formula = y~x, method = lm) +
  ggtitle("Dot Plot of Math Score by School") +
  labs(x = "School ID", y = "Math Score") +
  theme_clean()
```

## School vs Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_school_group, aes(x = school, y = School_Avg_PVRead)) +
  geom_point(color = "forestgreen") +
  geom_smooth(formula = y~x, method = lm) +
  ggtitle("Dot Plot of Reading Score by School") +
  labs(x = "School ID", y = "Reading Score") +
  theme_clean()
```

## School vs Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_school_group, aes(x = school, y = School_Avg_PVScience)) +
  geom_point(color = "tomato") +
  geom_smooth(formula = y~x, method = lm) +
  ggtitle("Dot Plot of Science Score by School") +
  labs(x = "School ID", y = "Science Score") +
  theme_clean()
```
:::

From the three dot plots above, we can get:

1.  In Math, most schools have students scoring between 500-600, with the next common range being 600-700. Two schools scored above 700, while two schools had notably lower scores around 400.

2.  In Reading, majority of schools show scores between 450-550, followed by 550-650. Five schools scored above 650, but two schools had notably low scores, falling below 400, with one even below 350.

3.  In Science, In most schools, students scored between 500-600, followed by 600-700. Two schools scored high (around 700), while two schools scored low (under 400).

4.  The three plots' shapes are similar, indicating consistent performance across subjects. Schools either perform well, average, or poorly in all subjects. Few schools show better reading performance than in math and science.

5.  Two schools consistently excel (upper left), while two consistently perform poorly (lower right) across all subjects.

6.  Though subtle, there's a slight downward trend in the fit curve, suggesting that as school codes increase, scores may potentially decrease.

### 4.2.2 Summary

## 4.3 Socioeconomic status

### 4.3.1 Parent's Highest Education Level

![](images/ISCED-levels.png){fig-align="center"}

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll

# Mom's edu level
MomEdu <- cbind(stu_qqq_SG[, c("CNTSTUID", "ST006Q01JA", "ST006Q02JA", "ST006Q03JA", "ST006Q04JA", "ST006Q05JA")])

get_highest_level <- function(row) {
  level_column <- grep("^ST006Q", names(row))
  if (any(!is.na(row[level_column]) & row[level_column] == 1)) {
    max_level_index <- which.max(row[level_column] == 1)
    return(9 - max_level_index)
  } else {
    return("<4")
  }
}
MomEdu$Mom_Level <- apply(MomEdu, 1, get_highest_level)

# Dad's edu level
DadEdu <- cbind(stu_qqq_SG[, c("CNTSTUID", "ST008Q01JA", "ST008Q02JA", "ST008Q03JA", "ST008Q04JA", "ST008Q05JA")])

get_highest_level <- function(row) {
  level_column <- grep("^ST008Q", names(row))
  if (any(!is.na(row[level_column]) & row[level_column] == 1)) {
    max_level_index <- which.max(row[level_column] == 1)
    return(9 - max_level_index)
  } else {
    return("<4")
  }
}
DadEdu$Dad_Level <- apply(DadEdu, 1, get_highest_level)

#Get the highest edu level
Parent_edu_level <- bind_cols(select(MomEdu, CNTSTUID, Mom_Level), select(DadEdu, Dad_Level)) %>%
  mutate(Parent_highest_level = pmax(Mom_Level, Dad_Level, na.rm = TRUE))
write_rds(Parent_edu_level, "data/stu_qqq_SG_Parent_edu_level.rds")

PV_Avg_Parent_edu_highestlevel <- cbind(PV_Avg, Parent_highest_level = Parent_edu_level$Parent_highest_level)
write_rds(PV_Avg_Parent_edu_highestlevel, "data/stu_qqq_SG_PV_Avg_Parent_edu_highestlevel.rds")

head(PV_Avg_Parent_edu_highestlevel)
```

::: panel-tabset
## Parent's Highest Edu Level vs Math Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data=PV_Avg_Parent_edu_highestlevel, aes(x = Avg_PVMath, fill = Parent_highest_level)) +
  geom_density(alpha = 1, color = NA) +
  facet_grid(Parent_highest_level ~ ., scales = "free_y", switch = "y") +
  scale_fill_brewer(palette = "Blues") +
  labs(x = "Math Score", fill = "<ISCED> Level") +
  ggtitle("Density Plots of Math Score by Parent's Highest Education Level") +
  theme_clean() +
  theme(
    plot.title = element_text(size = 12)
  )
```

## Parent's Highest Edu Level vs Reading Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data=PV_Avg_Parent_edu_highestlevel, aes(x = Avg_PVRead, fill = Parent_highest_level)) +
  geom_density(alpha = 1, color = NA) +
  facet_grid(Parent_highest_level ~ ., scales = "free_y", switch = "y") +
  scale_fill_brewer(palette = "Greens") +
  labs(x="Reading Score", fill = "<ISCED> level") +
  ggtitle("Density Plots of Reading Score by Parent's Highest Education Level") +
  theme_clean() +
  theme(
    plot.title = element_text(size = 12)
  )
```

## Parent's Highest Edu Level vs Science Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data=PV_Avg_Parent_edu_highestlevel, aes(x = Avg_PVScience, fill = Parent_highest_level)) +
  geom_density(alpha = 1, color = NA) +
  facet_grid(Parent_highest_level ~ ., scales = "free_y", switch = "y") +
  scale_fill_brewer(palette = "Reds") +
  labs(x="Science Score", fill = "<ISCED> level") +
  ggtitle("Density Plots of Science Score by Parent's Highest Education Level") +
  theme_clean() +
  theme(
    plot.title = element_text(size = 12)
  )
```
:::

::: panel-tabset
## Parent's Highest Edu Level vs Math Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_Parent_edu_highestlevel, aes(x = Parent_highest_level, y = Avg_PVMath, fill = Parent_highest_level)) +
  geom_violin() +
  geom_boxplot(width = 0.3, fill = "white", color = "black", alpha = 1) +
  scale_fill_brewer(palette = "Blues") +
  labs(x = "Parent's highest <ISCED> level", y = "Math Score", fill = "<ISCED> level") +
  ggtitle("Violin Plots with Boxplots of Math Score by Parent's Highest Education Level") +
  theme_clean() +
  theme(
    plot.title = element_text(size = 12)
  )
```

## Parent's Highest Edu Level vs Reading Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_Parent_edu_highestlevel, aes(x = Parent_highest_level, y = Avg_PVRead, fill = Parent_highest_level)) +
  geom_violin() +
  geom_boxplot(width = 0.3, fill = "white", color = "black", alpha = 1) +
  scale_fill_brewer(palette = "Greens") +
  labs(x = "Parent's highest <ISCED> level", y = "Math Score", fill = "<ISCED> level") +
  ggtitle("Violin Plots with Boxplots of Reading Score by Parent's Highest Education Level") +
  theme_clean() +
  theme(
    plot.title = element_text(size = 12)
  )
```

## Parent's Highest Edu Level vs Science Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_Parent_edu_highestlevel, aes(x = Parent_highest_level, y = Avg_PVScience, fill = Parent_highest_level)) +
  geom_violin() +
  geom_boxplot(width = 0.3, fill = "white", color = "black", alpha = 1) +
  scale_fill_brewer(palette = "Reds") +
  labs(x = "Parent's highest <ISCED> level", y = "Science Score", fill = "<ISCED> level") +
  ggtitle("Violin Plots with Boxplots of Science Score by Parent's Education Level") +
  theme_clean() +
  theme(
    plot.title = element_text(size = 12)
  )
```
:::

### 4.3.2 Home Possessions

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
HOMOPOS <- stu_qqq_SG %>%
  mutate(HOMOPOS_Number = coalesce(ST251Q01JA, 0) +
                              coalesce(ST251Q02JA, 0) +
                              coalesce(ST251Q03JA, 0) +
                              coalesce(ST251Q04JA, 0) +
                              coalesce(ST251Q06JA, 0) +
                              coalesce(ST251Q07JA, 0) +
                              coalesce(ST253Q01JA, 0) +
                              coalesce(ST255Q01JA, 0))
PV_Avg_HOMOPOS <- cbind(PV_Avg, Home_Possessions = HOMOPOS$HOMOPOS_Number)
write_rds(PV_Avg_HOMOPOS, "data/stu_qqq_SG_PV_Avg_HOMOPOS.rds")
head(PV_Avg_HOMOPOS)
```

::: panel-tabset
## Home Processions vs Math Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_HOMOPOS, aes(x = factor(Home_Possessions), y = Avg_PVMath)) +
  geom_boxplot(width = 0.5, fill = "lightblue") +
  labs(x = "Home Possessions Count", y = "Math Score", title = "Boxplots of Home Possessions Count and Math Score") +
  theme_clean()
```

## Home Processions vs Reading Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_HOMOPOS, aes(x = factor(Home_Possessions), y = Avg_PVRead)) +
  geom_boxplot(width = 0.5, fill = "lightgreen") +
  labs(x = "Home Possessions Count", y = "Reading Score", title = "Boxplots of Home Possessions Count and Reading Score") +
  theme_clean()
```

## Home Processions vs Science Score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| code-overflow: scroll
ggplot(data = PV_Avg_HOMOPOS, aes(x = factor(Home_Possessions), y = Avg_PVScience)) +
  geom_boxplot(width = 0.5, fill = "pink") +
  labs(x = "Home Possessions Count", y = "Science Score", title = "Boxplots of Home Possessions Count and Science Score") +
  theme_clean()
```
:::

# Reference

[PISA Data Analysis Manual: SPSS, Second Edition](https://read.oecd-ilibrary.org/education/pisa-data-analysis-manual-spss-second-edition_9789264056275-en#page1)

[How to prepare and analyse the PISA database](https://www.oecd.org/pisa/data/httpoecdorgpisadatabase-instructions.htm)

[How to Interpret Histograms](https://www.labxchange.org/library/items/lb:LabXchange:10d3270e:html:1)

[How to Interpret Violin Charts](https://www.labxchange.org/library/items/lb:LabXchange:46f64d7a:html:1)

[Computer-Based Student Questionnaire for Pisa 2022 - Main Survey Version](https://www.oecd.org/pisa/data/2022database/CY8_202111_QST_MS_STQ_CBA_NoNotes.pdf)
